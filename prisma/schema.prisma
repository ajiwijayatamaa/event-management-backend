// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             Int      @id @default(autoincrement())
  name           String   @db.VarChar(100)
  email          String   @unique @db.VarChar(255)
  password       String   @db.VarChar(255)
  role           Role     @default(CUSTOMER)
  referralCode   String   @unique @map("referral_code") @db.VarChar(20)
  referredBy     Int?     @map("referred_by")
  referrer       User?    @relation("UserReferrals", fields: [referredBy], references: [id], onDelete: SetNull)
  referrals      User[]   @relation("UserReferrals")
  profilePicture String?  @map("profile_picture") @db.Text
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  events       Event[]
  points       Point[]
  coupons      Coupon[]
  transactions Transaction[]
  reviews      Review[]

  @@map("users")
}

model Event {
  id             Int      @id @default(autoincrement())
  organizerId    Int      @map("organizer_id")
  organizer      User     @relation(fields: [organizerId], references: [id], onDelete: Cascade)
  name           String   @db.VarChar(255)
  description    String?  @db.Text
  price          Decimal  @default(0) @db.Decimal(12, 2)
  image          String?  @db.Text
  location       String?  @db.Text
  availableSeats Int      @map("available_seats")
  totalSeats     Int      @map("total_seats")
  startDate      DateTime @map("start_date") @db.Timestamptz(6)
  endDate        DateTime @map("end_date") @db.Timestamptz(6)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  vouchers     Voucher[]
  transactions Transaction[]

  @@map("events")
}

model Point {
  id              Int      @id @default(autoincrement())
  userId          Int      @map("user_id")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount          Int      @default(10000)
  remainingAmount Int      @default(10000) @map("remaining_amount")
  expiredAt       DateTime @map("expired_at") @db.Timestamptz(6)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("points")
}

model Coupon {
  id           Int      @id @default(autoincrement())
  userId       Int      @map("user_id")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  couponCode   String   @unique @map("coupon_code") @db.VarChar(50)
  discountRate Decimal  @map("discount_rate") @db.Decimal(5, 2)
  isUsed       Boolean  @default(false) @map("is_used")
  expiredAt    DateTime @map("expired_at") @db.Timestamptz(6)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  transactions Transaction[]

  @@map("coupons")
}

model Voucher {
  id                 Int      @id @default(autoincrement())
  eventId            Int      @map("event_id")
  event              Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  voucherCode        String   @map("voucher_code") @db.VarChar(50)
  discountPercentage Decimal  @map("discount_percentage") @db.Decimal(5, 2)
  quota              Int
  startDate          DateTime @map("start_date") @db.Timestamptz(6)
  endDate            DateTime @map("end_date") @db.Timestamptz(6)
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  transactions Transaction[]

  @@map("vouchers")
}

model Transaction {
  id                     Int               @id @default(autoincrement())
  userId                 Int               @map("user_id")
  user                   User              @relation(fields: [userId], references: [id])
  eventId                Int               @map("event_id")
  event                  Event             @relation(fields: [eventId], references: [id])
  voucherId              Int?              @map("voucher_id")
  voucher                Voucher?          @relation(fields: [voucherId], references: [id])
  couponId               Int?              @map("coupon_id")
  coupon                 Coupon?           @relation(fields: [couponId], references: [id])
  ticketQuantity         Int               @map("ticket_quantity")
  totalPrice             Decimal           @map("total_price") @db.Decimal(12, 2)
  pointsUsed             Int               @default(0) @map("points_used")
  status                 TransactionStatus @default(PENDING)
  paymentProof           String?           @map("payment_proof") @db.Text
  paymentProofUploadedAt DateTime?         @map("payment_proof_uploaded_at") @db.Timestamptz(6)
  expiredAt              DateTime          @map("expired_at") @db.Timestamptz(6)
  confirmedAt            DateTime?         @map("confirmed_at") @db.Timestamptz(6)
  createdAt              DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  review Review?

  @@map("transactions")
}

model Review {
  id            Int         @id @default(autoincrement())
  transactionId Int         @unique @map("transaction_id")
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  userId        Int         @map("user_id")
  user          User        @relation(fields: [userId], references: [id])
  rating        Int
  comment       String?     @db.Text
  createdAt     DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime    @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("reviews")
}

enum Role {
  CUSTOMER
  ORGANIZER
}

enum TransactionStatus {
  PENDING
  PAID
  REJECTED
  EXPIRED
}
